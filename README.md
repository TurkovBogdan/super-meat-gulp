# super-meat-gulp
Версия: 0.9a

Нафаршированный в мясо сборщик

[Функционал](#Функционал)<br>
[Требования](#Требования)<br>
[Установка](#Установка)


## Функционал
**Настройки**<br>
Все настройки выведены в [отельный файл](https://github.com/TurkovBogdan/super-meat-gulp/blob/master/.gulp/conf-bitrix.js). Можно настроить:<br>
— Пути к файлам<br>
— Включение/отключение задач<br>
— Включение/отключение плагинов<br>

Настройка путей минималистична, часть путей генерируется автоматически. К примеру, вам не нужно настраивать пути и исключения для watch.
Есть несколько готовых файлов конфигурации для проектов на symphony и bitrix.

**Сборка основного и дополнительных стилей:**<br>
— препроцессор PostCSS + SCSS<br>
— генерация SourceMap<br>
— автопрефиксы<br>
— минификация<br>
— объединение и перемещение медиа запроссов в конец файла<br>
— watch

Сборка основных стилей:
```
gulp styles:main
```

Сборка дополнительных стилей. Все scss файлы помещённые в специальную директорию (по умолчанию /styles/pages/) будут собранны и сохранены отдельно.
```
gulp styles:additional
```

**Генерация спрайтов**<br>
— неограниченное кол-во наборов спрайтов<br>
— создание спрайтов с поддержкой ретины (авторесайз, достаточно загрузить x2)<br>
— оптимизация изображений спрайтов
— добавление хеша к имени изображений, для автообновления картинок у пользователя<br>
— watch

Сборка спрайтов без поддержки ретины. Будут обработанны все папки в директории (по умолчанию img/.sprites/), на основе каждой  будет создан отдельный спрайт. Код спрайтов сохнариться в папку (по умолчанию styles/sprites/).
```
gulp sprites:not-retina
```
Сборка спрайтов с поддержкой ретины. Будут обработанны все папки в директории (по умолчанию img/.sprites-retina/), на основе каждой  будет создан отдельный спрайт. Код спрайтов сохнариться в папку (по умолчанию styles/sprites-retina/).
```
gulp sprites:retina
```
*Примеры использования спрайтов доступны в любом scss файле спрайтов*


**Сборка основного и дополнительных скритов**<br>
— генерация SourceMap<br>
— обработка кода через babel, можно использовать es6<br>
— минификация<br>
— watch<br>

Сборка основного скрипта:
```
gulp scripts:main
```

Сборка дополнительных скриптов. Все js файлы помещённые в специальную директорию (по умолчанию scripts/additionally/) будут собранны и сохранены отдельно.
```
gulp scripts:additional
```

**Обработка изображений**<br>
Автоматическое копирование и оптимизация изображений. Можно использовать оптимизацию с потерей качества, будут затронуты только те изображения, которые не обрабатывались или были повторно загруженны.<br>

Для оптимизации используеться:
— mozjpeg / jpegtran (если mozjpeg вызывает ошибки, его можно отключить)
— pngquant
— giflossy
— svgo

```
gulp images:optimization
```

**Автоматическое создание структуры и установка заготовок скриптов/стилей**<br>
Сборщик может самостоятельно создать структуру проекта на основе файла конфигурации. За это отвечает задача:
```
gulp project:create-structure
```
Будут созданы все директории для изображений, спрайтов, стилей, скриптов, и файлы, с которых начинается сборка проекта. Также, вы можете выбрать и установить несколько заготовок для скриптов и стилей. Для этого найдите параметр *patterns* в разделе настроек скриптов или стилей, и укажите требуемые заготовки. 

К примеру, при выборе паттерна *sass-7-1-without-themes*, в стилях будет созданна следующая структура:
```
base/
  _base.scss
  _fonts.scss
  _helpers.scss
  _typography.scss
layout/
  _header.scss
  _footer.scss
components/
  _button.scss
  ...
pages/
abstracts/
vendors/
```
А код подключения файлов автоматически добавиться в файл, с которого начинается сборка ситлей.

Список доступных заготовок можно посмотреть в директории [*.gulp/pattern/*](https://github.com/TurkovBogdan/super-meat-gulp/tree/master/.gulp/pattern)<br>

## Требования
**0.Сервер**<br>
RAM >= 2GB<br>
Cборщик использует ~260-589mb оперативки. Если её меньше 2GB, не пробуйте его устанавливать, только потеряете время.
(при 512mb не сможете установить, при 1gb ошибки нехватки памяти при работе с графикой).

Ставим пакеты для компиляции. Если пропустите этот шаг, возможны проблемы при установке NPM пакетов для оптимизации изображений
```
yum install -y gcc libpng libjpeg libpng-devel libjpeg-devel ghostscript libtiff libtiff-devel freetype freetype-devel libtool automake autoconf nasm
```

**1. Git**
```
yum install git
```

**2. [NodeJS](https://nodejs.org/en/download/package-manager/) (тестировалось на версиях v6.9.2 и v10.1.0)**
```
curl --silent --location https://rpm.nodesource.com/setup_10.x | sudo bash -
sudo yum -y install nodejs
```

**3. Gulp**
```
npm install --global gulp
```

**4. GraphicsМagick версии 1.3.21 (или выше).**
```
yum install graphicsmagick
gm version
```
*Если установленная версия ниже минимальной или пакет не найден, смотри [установку GraphicsМagick из исходников](#Установка-graphicsМagick-из-исходников)*



## Установка
1. Скопируйте репозиторий используя команду
```
git clone https://github.com/TurkovBogdan/super-meat-gulp.git
```
2. Удалите .gitignore и папку .git
3. Скопируйте все файлы в папку шаблона
4. Установите пакеты требуемые для работы сборщика
```
npm install
```

Если папка с шаблоном пуста, можете установить всё одной коммандой: 
```
git clone https://github.com/TurkovBogdan/super-meat-gulp.git . && rm -rf .git && rm .gitignore && npm install
```

## TODO
— сборка стилей, добавить url rebase
— сборка стилей, добавить версию к изображениям
— сборка стилей, добавить возможность отключить PostCSS плагины и перейти на обычный набор (слишком долгое выполнение при большом колличестве стилей)
— сборка скриптов, добавить обфускацию
— сборка дополнительных скриптов, добавить возможность указывать плагины требуемые для сборки в имени файла (surfix)

## Возможно
— впихнуть webpack для обработки скриптов

## FAQ
### Установка GraphicsМagick из исходников
```
# Переходим в временную директорию
cd /tmp/

# Скачиваем исходники gm
wget https://sources.voidlinux.eu/GraphicsMagick-1.3.30/GraphicsMagick-1.3.30.tar.gz
tar zxvf GraphicsMagick-1.3.30.tar.gz

# Компилим и устанавливаем
cd GraphicsMagick-1.3.9
./configure --enable-shared
make
make install

# Проверяем версию
gm version
```

### Как работать с генератором спрайтов

## История версий
*0.9а* — Первая тестовая версия
